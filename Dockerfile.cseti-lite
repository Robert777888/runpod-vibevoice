FROM --platform=linux/amd64 runpod/pytorch:2.1.0-py3.10-cuda11.8.0-devel-ubuntu22.04

# Munkak√∂rnyezet be√°ll√≠t√°sa
WORKDIR /workspace

# Rendszer csomagok telep√≠t√©se
RUN apt-get update && apt-get install -y \
    git \
    wget \
    curl \
    vim \
    ffmpeg \
    libsndfile1 \
    git-lfs \
    && git lfs install \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Python f√ºgg≈ës√©gek telep√≠t√©se - KOMPATIBILIS VERZI√ìK
RUN pip install --no-cache-dir --upgrade pip setuptools wheel && \
    pip install --no-cache-dir \
    torch==2.1.0 torchvision==0.16.0 torchaudio==2.1.0 --index-url https://download.pytorch.org/whl/cu118 && \
    pip install --no-cache-dir \
    transformers==4.34.0 \
    tokenizers==0.14.1 \
    huggingface-hub==0.17.3 \
    accelerate==0.23.0 \
    xformers==0.0.22.post7 \
    soundfile==0.12.1 \
    librosa==0.10.1 \
    scipy==1.11.4 \
    pydub==0.25.1 \
    gradio==3.50.2 \
    fastapi==0.104.1 \
    uvicorn[standard]==0.24.0

# ComfyUI kl√≥noz√°sa
RUN git clone https://github.com/comfyanonymous/ComfyUI.git /workspace/ComfyUI

# ComfyUI f√ºgg≈ës√©gek telep√≠t√©se
WORKDIR /workspace/ComfyUI
RUN pip install --no-cache-dir -r requirements.txt

# VibeVoice Custom Node telep√≠t√©se
WORKDIR /workspace/ComfyUI/custom_nodes
RUN git clone https://github.com/Enemyx-net/VibeVoice-ComfyUI.git

# VibeVoice f√ºgg≈ës√©gek telep√≠t√©se
WORKDIR /workspace/ComfyUI/custom_nodes/VibeVoice-ComfyUI
RUN if [ -f requirements.txt ]; then pip install --no-cache-dir -r requirements.txt; fi

# ===================================
# MAPPASTRUKT√öRA L√âTREHOZ√ÅSA
# ===================================
WORKDIR /workspace/ComfyUI
RUN mkdir -p models/vibevoice \
    && mkdir -p input/audio \
    && mkdir -p output/audio

# ===================================
# INFO √úZENET
# ===================================
RUN echo "==========================================" && \
    echo "üá≠üá∫ CSETI MAGYAR TTS - LITE VERSION" && \
    echo "==========================================" && \
    echo "" && \
    echo "‚úÖ ComfyUI telep√≠tve" && \
    echo "‚úÖ VibeVoice node telep√≠tve" && \
    echo "‚úÖ Python dependencies telep√≠tve" && \
    echo "" && \
    echo "üì• MODELLEK POD INDUL√ÅSKOR LET√ñLT≈êDNEK!" && \
    echo "   (~17GB - els≈ë indul√°s 10-15 perc)" && \
    echo "" && \
    echo "==========================================" && \
    echo "Docker image m√©ret: ~8 GB (models n√©lk√ºl)" && \
    echo "=========================================="

# Start script m√°sol√°sa
COPY start.sh /workspace/start.sh
RUN chmod +x /workspace/start.sh

# Port megnyit√°sa
EXPOSE 8188 7860

# Munkak√∂rnyezet vissza√°ll√≠t√°sa
WORKDIR /workspace/ComfyUI

# Alap√©rtelmezett parancs
CMD ["/workspace/start.sh"]

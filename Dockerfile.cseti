FROM --platform=linux/amd64 runpod/pytorch:2.1.0-py3.10-cuda11.8.0-devel-ubuntu22.04

# Munkak√∂rnyezet be√°ll√≠t√°sa
WORKDIR /workspace

# Rendszer csomagok telep√≠t√©se
RUN apt-get update && apt-get install -y \
    git \
    wget \
    curl \
    vim \
    ffmpeg \
    libsndfile1 \
    git-lfs \
    && git lfs install \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Python f√ºgg≈ës√©gek telep√≠t√©se - KOMPATIBILIS VERZI√ìK
RUN pip install --no-cache-dir --upgrade pip setuptools wheel && \
    pip install --no-cache-dir \
    torch==2.1.0 torchvision==0.16.0 torchaudio==2.1.0 --index-url https://download.pytorch.org/whl/cu118 && \
    pip install --no-cache-dir \
    transformers==4.34.0 \
    tokenizers==0.14.1 \
    huggingface-hub==0.17.3 \
    accelerate==0.23.0 \
    xformers==0.0.22.post7 \
    soundfile==0.12.1 \
    librosa==0.10.1 \
    scipy==1.11.4 \
    pydub==0.25.1 \
    gradio==3.50.2 \
    fastapi==0.104.1 \
    uvicorn[standard]==0.24.0

# ComfyUI kl√≥noz√°sa
RUN git clone https://github.com/comfyanonymous/ComfyUI.git /workspace/ComfyUI

# ComfyUI f√ºgg≈ës√©gek telep√≠t√©se
WORKDIR /workspace/ComfyUI
RUN pip install --no-cache-dir -r requirements.txt

# VibeVoice Custom Node telep√≠t√©se
WORKDIR /workspace/ComfyUI/custom_nodes
RUN git clone https://github.com/Enemyx-net/VibeVoice-ComfyUI.git

# VibeVoice f√ºgg≈ës√©gek telep√≠t√©se
WORKDIR /workspace/ComfyUI/custom_nodes/VibeVoice-ComfyUI
RUN if [ -f requirements.txt ]; then pip install --no-cache-dir -r requirements.txt; fi

# ===================================
# HELYES MAPPASTRUKT√öRA L√âTREHOZ√ÅSA
# ===================================
WORKDIR /workspace/ComfyUI
RUN mkdir -p models/vibevoice/VibeVoice_7B_hun_v2 \
    && mkdir -p models/vibevoice/tokenizer \
    && mkdir -p models/vibevoice/loras \
    && mkdir -p input/audio \
    && mkdir -p output/audio

# ===================================
# CSETI MAGYAR MODELLEK LET√ñLT√âSE
# ===================================

# üá≠üá∫ 1. CSETI F≈ê MAGYAR MODELL (Full Finetune, ~14GB)
RUN echo "üá≠üá∫ üì• Cseti Magyar Modell let√∂lt√©se (VibeVoice_7B_hun_v2)..." && \
    cd /workspace/ComfyUI/models/vibevoice && \
    huggingface-cli download Cseti/VibeVoice_7B_hun_v2 \
    --local-dir VibeVoice_7B_hun_v2 \
    --local-dir-use-symlinks False && \
    echo "‚úÖ Cseti Magyar Modell k√©sz!"

# üá≠üá∫ 2. TOKENIZER (Qwen 2.5, ~11MB)
RUN echo "üì• Tokenizer let√∂lt√©se..." && \
    cd /workspace/ComfyUI/models/vibevoice/tokenizer && \
    huggingface-cli download Qwen/Qwen2.5-1.5B \
    tokenizer_config.json \
    vocab.json \
    merges.txt \
    tokenizer.json \
    --local-dir . \
    --local-dir-use-symlinks False && \
    echo "‚úÖ Tokenizer k√©sz!"

# üá≠üá∫ 3. MAGYAR LoRA - MIND A 3 VERZI√ì (600, 900, 1200)
# Let√∂ltj√ºk az eg√©sz repot egyszer, majd √°tstruktur√°ljuk
RUN echo "üá≠üá∫ üì• Magyar LoRA-k let√∂lt√©se (MIND A 3)..." && \
    cd /workspace/ComfyUI/models/vibevoice/loras && \
    \
    echo "üì• Teljes LoRA repo let√∂lt√©se..." && \
    huggingface-cli download Cseti/VibeVoice_7B_Diffusion-head-LoRA_Hungarian-CV17 \
    --local-dir lora-temp \
    --local-dir-use-symlinks False && \
    \
    echo "  ‚Üí LoRA 600 strukt√∫ra..." && \
    mkdir -p HUN-600/diffusion_head && \
    cp lora-temp/diffusion_head600/adapter_config.json HUN-600/ && \
    cp lora-temp/diffusion_head600/model.safetensors HUN-600/diffusion_head/adapter_model.safetensors && \
    \
    echo "  ‚Üí LoRA 900 strukt√∫ra..." && \
    mkdir -p HUN-900/diffusion_head && \
    cp lora-temp/diffusion_head900/adapter_config.json HUN-900/ && \
    cp lora-temp/diffusion_head900/model.safetensors HUN-900/diffusion_head/adapter_model.safetensors && \
    \
    echo "  ‚Üí LoRA 1200 strukt√∫ra..." && \
    mkdir -p HUN-1200/diffusion_head && \
    cp lora-temp/diffusion_head1200/adapter_config.json HUN-1200/ && \
    cp lora-temp/diffusion_head1200/model.safetensors HUN-1200/diffusion_head/adapter_model.safetensors && \
    \
    rm -rf lora-temp && \
    echo "‚úÖ Mind a 3 LoRA k√©sz!"

# ===================================
# ELLEN≈êRZ√âS √âS LOGOL√ÅS
# ===================================
RUN echo "==========================================" && \
    echo "üá≠üá∫ CSETI MAGYAR TTS - TELEP√çTETT MODELLEK" && \
    echo "==========================================" && \
    echo "" && \
    echo "üìÅ Cseti Magyar Modell (VibeVoice_7B_hun_v2):" && \
    ls -lh /workspace/ComfyUI/models/vibevoice/VibeVoice_7B_hun_v2/ | head -8 && \
    echo "" && \
    echo "üìÅ Tokenizer:" && \
    ls -lh /workspace/ComfyUI/models/vibevoice/tokenizer/ && \
    echo "" && \
    echo "üìÅ Magyar LoRA-k:" && \
    echo "  ‚Üí HUN-600:" && \
    ls -lhR /workspace/ComfyUI/models/vibevoice/loras/HUN-600/ && \
    echo "  ‚Üí HUN-900:" && \
    ls -lhR /workspace/ComfyUI/models/vibevoice/loras/HUN-900/ && \
    echo "  ‚Üí HUN-1200:" && \
    ls -lhR /workspace/ComfyUI/models/vibevoice/loras/HUN-1200/ && \
    echo "" && \
    echo "‚úÖ Minden Cseti modell telep√≠tve!" && \
    echo "==========================================" && \
    echo "üéâ MAGYAR TTS PRODUCTION READY!" && \
    echo "=========================================="

# Start script m√°sol√°sa
COPY start.sh /workspace/start.sh
RUN chmod +x /workspace/start.sh

# Port megnyit√°sa
EXPOSE 8188 7860

# Munkak√∂rnyezet vissza√°ll√≠t√°sa
WORKDIR /workspace/ComfyUI

# Alap√©rtelmezett parancs
CMD ["/workspace/start.sh"]
